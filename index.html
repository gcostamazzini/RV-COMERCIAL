
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Comercial ‚Äì Upload de Excel (Regras v6.5 + RV Supervis√£o & RV GERENTES)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{ --bg:#f8fafc; --header:#ffffff; --text:#0f172a; --muted:#475569; --card:#ffffff; --border:#e2e8f0; }
    body{ background:var(--bg); color:var(--text); }
    header{ background:var(--header); border-bottom:1px solid var(--border); }
    .card{ background:var(--card); border:1px solid var(--border); }
    .kpi{ font-weight:700; font-size:1.6rem; }
    .sub{ color:var(--muted); font-size:0.9rem; }
    .badge{ font-size:0.85rem; }
    .table thead th{ position:sticky; top:0; background:#f1f5f9; }
    tfoot td{ font-weight:700; background:#eef2f7; }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
<header class="py-3 px-4 d-flex align-items-center justify-content-between">
  <div>
    <h1 class="h4 mb-0">ü´µüèªü´∞üèºüíµüí∞üí∞REMUNERA√á√ÉO VARI√ÅVEL - RVüí∞üí∞üíµü´∞üèºü´µüèª</h1>
    <div class="sub">Upload do Excel, filtros, totalizador, exporta√ß√£o e RV Supervisores (prote√ß√£o por senha)</div>
  </div>
  <div class="d-flex align-items-center gap-2">
    <input id="fileInput" class="form-control" type="file" accept=".xlsx,.xls" />
  </div>
</header>

<div class="container-fluid p-4">
  <!-- KPIs -->
  <div class="row g-3 mb-2">
    <div class="col-12 col-md-3"><div class="card p-3 h-100"><div class="sub">Vendas (R$)</div><div id="kpiVendasValor" class="kpi">0</div></div></div>
    <div class="col-12 col-md-3"><div class="card p-3 h-100"><div class="sub">Comiss√£o Rent (I ‚Äì soma)</div><div id="kpiRentValor" class="kpi">0</div></div></div>
    <div class="col-12 col-md-3"><div class="card p-3 h-100"><div class="sub">Estornos descontados (15%)</div><div id="kpiEstValor" class="kpi">0</div></div></div>
    <div class="col-12 col-md-3"><div class="card p-3 h-100"><div class="sub">√Ä Receber (R$)</div><div id="kpiTotal" class="kpi">0</div></div></div>
  </div>

  <!-- Filtros -->
  <div class="card p-3 mb-3">
    <div class="row g-3 align-items-end">
      <div class="col-12 col-md-4">
        <label class="form-label sub">Filtrar por Gestor</label>
        <select id="fltGestor" class="form-select" multiple size="8"></select>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-outline-primary" id="btnClearGestor">Limpar</button>
          <button class="btn btn-sm btn-outline-secondary" id="btnSelectAllGestor">Selecionar todos</button>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label sub">Filtrar por Setor</label>
        <select id="fltSetor" class="form-select" multiple size="8"></select>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-outline-primary" id="btnClearSetor">Limpar</button>
          <button class="btn btn-sm btn-outline-secondary" id="btnSelectAllSetor">Selecionar todos</button>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label sub">Buscar Colaborador/ID</label>
        <input id="txtBusca" class="form-control" placeholder="Digite parte do nome ou ID" />
        <div class="filter-badges mt-2" id="activeFilters"></div>
        <div class="form-text">Dica: para selecionar m√∫ltiplos itens na lista, use Ctrl/‚åò ou Shift.</div>
      </div>
    </div>
  </div>

  <!-- Gr√°ficos -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-lg-6"><div class="card p-3 h-100"><div class="sub mb-2">Somat√≥rio Financeiro por Gestor</div><canvas id="chartGestor"></canvas></div></div>
    <div class="col-12 col-lg-6"><div class="card p-3 h-100"><div class="sub mb-2">Top 10 por √Ä Receber (R$)</div><canvas id="chartTop"></canvas></div></div>
  </div>

  <!-- Tabela Detalhada -->
  <div class="card p-3 mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="sub">Tabela Detalhada (filtr√°vel)</div>
      <div>
        <button id="btnExportar" class="btn btn-sm btn-success">Exportar tabela para Excel</button>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-striped" id="tblResumo">
        <thead>
  <tr>
    <th>ID VENDEDOR</th>
    <th>COLABORADOR</th>
    <th>SETOR</th>
    <th>GESTOR</th>
    <th>QTD Vendas</th>
    <th>Vendas (R$)</th>
    <th>QTD Rent</th>
    <th>Rentab. (R$)</th>
    <th>Estornos (R$)</th>
    <th>Estornos (R$)</th>
    <th>QTDE SKY+</th> <!-- üîπ nova coluna -->
    <th>SKY+ (R$)</th> <!-- üîπ nova coluna -->
    <th>QTD Reten√ß√£o</th> <!-- üîπ nova coluna -->
    <th>Reten√ß√£o (R$)</th> <!-- üîπ nova coluna -->


    <th>√Ä Receber (R$)</th>
  </tr>
</thead>

        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="4" class="text-end">Totais:</td>
            <td id="ftQVend">0</td>
            <td id="ftV15">R$¬†0,00</td>
            <td id="ftQRent">0</td>
            <td id="ftRent">R$¬†0,00</td>
            <td id="ftQEst">0</td>
            <td id="ftEst">R$¬†0,00</td>
            <td id="ftTotal">R$¬†0,00</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Bot√£o de acesso RV SUPERVIS√ÉO (j√° existente v6.3) + novo bot√£o RV GERENTES -->
  <div class="d-flex gap-2 justify-content-end mb-2">
    <button id="btnRvAccess" class="btn btn-sm btn-dark">RV SUPERVIS√ÉO</button>
    <button id="btnRvGerAccess" class="btn btn-sm btn-primary">RV GERENTES</button>
  </div>



  <!-- RV Supervisores (inicialmente oculto) ‚Äì estrutura intacta v6.3 -->
 <div id="rvCard" class="card p-3 mb-3 hidden">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="sub">RV Supervisores</div>
    <div id="rvInfo" class="sub"></div>
  </div>

  <!-- üîë NOVO: bot√£o trocar senha (somente supervisor logado) -->
  <div class="mb-2">
    <button
      id="btnChangeMyPass"
      class="btn btn-sm btn-outline-warning hidden">
      Alterar minha senha
    </button>
  </div>

  <div id="rvMasterPanel" class="hidden mb-2">
    <button id="btnShowPasswords" class="btn btn-sm btn-outline-secondary">
      Mostrar senhas (Gerente)
    </button>
    <div id="rvPasswordsList" class="mt-2 hidden">
      <div class="sub">Senhas por Supervisor (v√°lidas nesta sess√£o):</div>
      <ul id="rvPasswordsUl" class="small"></ul>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm table-striped" id="tblSupervisores">
      <thead>
        <tr>
          <th>SUPERVISOR</th>
          <th>META BL</th>
          <th>REALIZADO</th>
          <th>% ATINGIDO</th>
          <th>VALOR A RECEBER</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="mt-2">
    <button id="btnRvHide" class="btn btn-sm btn-outline-danger">
      Ocultar RV Supervisores
    </button>
  </div>
</div>


  <!-- NOVO: RV GERENTES (totalmente independente; oculto e s√≥ aparece com senhas 0325 ou 6455) -->
  <div id="rvGerCard" class="card p-3 mb-3 hidden">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="sub">RV GERENTES</div>
      <div id="rvGerInfo" class="sub"></div>
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-striped" id="tblGerentes">
        <thead>
          <tr>
            <th>GERENTE</th>
            <th>META BL</th>
            <th>REALIZADO</th>
            <th>% ATINGIDO</th>
            <th>VALOR A RECEBER</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="mt-2">
      <button id="btnRvGerHide" class="btn btn-sm btn-outline-danger">Ocultar RV GERENTES</button>
    </div>
  </div>

  <div class="text-end sub"><span id="year"></span></div>
</div>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

// ===== Helpers =====
const removeAccents = s => (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'');
const norm = s => removeAccents(String(s||'').toLowerCase().trim());
function parseNumber(v){ if(v==null) return 0; if(typeof v === 'number') return v; let s = String(v).trim(); if(!s) return 0; if(/,\d{1,2}$/.test(s)) s = s.replace(/\./g,'').replace(',','.'); return Number(s.replace(/[^0-9.-]/g,'')) || 0; }
function sheetToRows(sheet){ return XLSX.utils.sheet_to_json(sheet, {defval:null}); }
function findSheet(wb, targets){ const names = wb.SheetNames; const tnorms = targets.map(norm); for(const n of names){ if(tnorms.includes(norm(n))) return n; } for(const n of names){ const nn = norm(n); if(tnorms.some(t => nn.includes(t))) return n; } return null; }
function colByName(rows, targetNames){ if(!rows || !rows.length) return null; const headers = Object.keys(rows[0]||{}); const targetNorms = targetNames.map(n=>norm(n)); for(const h of headers){ if(targetNorms.includes(norm(h))) return h; } for(const h of headers){ const hn = norm(h); if(targetNorms.some(t => hn.includes(t))) return h; } return null; }
const fmtBRL = n => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n);
const fmtPct = n => (n||0).toLocaleString('pt-BR', {minimumFractionDigits:1, maximumFractionDigits:1}) + '%';

// ======> COLOQUE AQUI SUA FUN√á√ÉO
function processSkySheet(workbook) {
    const sheetName = findSheet(workbook, ['sky']);
    if (!sheetName) return new Map();
    const rows = sheetToRows(workbook.Sheets[sheetName]);
    const mapSky = new Map();
    const cId = colByName(rows, ['id vendedor','id_vendedor','id do vendedor']);
    if(!cId) return mapSky;

    rows.forEach(r=>{
        const id = parseNumber(r[cId]);
        if(!id) return;
        const prev = mapSky.get(id) || {qtd:0, valor:0};
        prev.qtd += 1;
        prev.valor = prev.qtd * 10;
        mapSky.set(id, prev);
    });
    return mapSky;
}

function processRetencaoSheet(workbook){
    const sheetName = findSheet(workbook, ['retencao','reten√ß√£o']);
    if(!sheetName) return new Map();
    const rows = sheetToRows(workbook.Sheets[sheetName]);

    const cId = colByName(rows, ['id vendedor','id_vendedor','id do vendedor']);
    const cTotal = colByName(rows, ['total geral']);
    const cRetido = colByName(rows, ['retido','cliente retido']);

    if(!cId || !cTotal || !cRetido) return new Map();

    const mapRet = new Map();
    rows.forEach(r=>{
        const id = parseNumber(r[cId]);
        if(!id) return;

        const tot = parseNumber(r[cTotal]);
        const ret = parseNumber(r[cRetido]);

        const prev = mapRet.get(id) || {qtdTotal:0, qtdRetido:0};
        prev.qtdTotal += tot;
        prev.qtdRetido += ret;
        mapRet.set(id, prev);
    });

    return mapRet;
}



// ===== Estado (v6.3) =====
let filasRowsRaw=[], vendRowsRaw=[], metasRowsRaw=[];
let rentRowsRaw=[]; // (novo) para RV Gerentes ‚Äì n√£o impacta o restante
let rowsResumo=[]; let filtrosInicializados=false; const state={ gSel:[], sSel:[], q:'' };
const setoresComGatilho = new Set(['vendas/rentabilidade','vendas/retencao','vendas','vendas/reten√ß√£o']);


  // ===== RV Auth (Supervis√£o v6.3 intacta) =====
// ===== RV Auth (Supervis√£o v6.3 intacta) =====
const MASTER_PASS = '1705';

// Senhas padr√£o (fallback)
let rvPasswords = {
  'Adriana':  '8878',
  'Amanda':   '5838',
  'Bianca':   '2607',
  'Denis':    '0604',
  'Kaoani':   '1925',
  'Kelly':    '5966',
  'Lais':     '6534',
  'Simone':   '8175',
  'Tainara':  '6334',
  'Welington':'9627'
};

// üîΩüîΩüîΩ COLE AQUI ‚Äî LOGO ABAIXO üîΩüîΩüîΩ
const saved = localStorage.getItem('rvPasswords');
if (saved) {
  rvPasswords = JSON.parse(saved);
}

// Estado de autentica√ß√£o
let rvAuth = { role:null, supervisor:null };



// üîê Carregar senhas salvas (se existirem)
const savedRvPasswords = localStorage.getItem('rvPasswords');
if(savedRvPasswords){
  rvPasswords = JSON.parse(savedRvPasswords);
}



// ===== Acessos Especiais RV (ADI√á√ÉO) =====
const RV_SPECIAL_ACCESS = {
  '2908': {
    rvSupervisores: true,
    rvGerentes: {
      enabled: true,
      gestor: 'ALAN PARANHOS'
    }
  },
  '9911': {
    rvSupervisores: false,
    rvGerentes: {
      enabled: true,
      gestor: 'ANDRIELE VELOSO'
    }
  }
};

let rvGerenteFiltro = null;

// ===== Utils =====
function gen4d(){
  return String(Math.floor(Math.random()*10000)).padStart(4,'0');
}

function ensureUniquePass(existing){
  let p;
  do{ p=gen4d(); }
  while(Object.values(existing).includes(p));
  return p;
}



function showRv(role, sup){
  rvAuth.role = role;
  rvAuth.supervisor = sup || null;

  document.getElementById('rvCard').classList.remove('hidden');

  const info = document.getElementById('rvInfo');
  const masterPanel = document.getElementById('rvMasterPanel');
  const btnChange = document.getElementById('btnChangeMyPass');

  if(role === 'master'){
    info.textContent = 'Acesso: Gerente (visualiza todos)';
    masterPanel.classList.remove('hidden');
    btnChange.classList.add('hidden'); // ‚ùå master n√£o troca senha
  } else {
    info.textContent = 'Acesso: Supervisor ‚Äì ' + sup;
    masterPanel.classList.add('hidden');
    btnChange.classList.remove('hidden'); // ‚úÖ supervisor pode trocar
  }

  updateSupervisores();
}


function hideRv(){
  document.getElementById('rvCard').classList.add('hidden');
  rvAuth = {role:null, supervisor:null};
  rvGerenteFiltro = null;
}

function handleRvAccess(){
  if(Object.keys(rvPasswords).length===0) buildRvPasswords();

  const pass = prompt('Digite sua senha para acessar RV Supervis√£o:');
  if(pass == null) return;

  // üîë MASTERS (SEM ALTERAR OS EXISTENTES)
if(pass === MASTER_PASS || pass === '5150' || pass === '2908'){
  rvPasswords['__MASTER__'] = pass; // registra quem entrou
  showRv('master');
  return;
}


  // üö´ 9911 N√ÉO acessa RV Supervisores
  if(pass === '9911'){
    alert('Acesso negado.');
    return;
  }

  // Supervisores normais (IGUAL ANTES)
  const entry = Object.entries(rvPasswords).find(([sup,p])=> p===pass);
  if(entry){
    const [sup] = entry;
    showRv('supervisor', sup);
  } else {
    alert('Senha inv√°lida.');
  }
}

function handleChangeMyPassword(){
  if(!rvAuth || !rvAuth.role){
    alert('Fa√ßa login primeiro.');
    return;
  }

  let userKey = null;

  // üîë MASTER (1705 / 5150 / 2908)
  if(rvAuth.role === 'master'){
    userKey = '__MASTER__'; // chave √∫nica
    rvPasswords[userKey] = rvPasswords[userKey] || MASTER_PASS;
  }

  // üë§ SUPERVISOR
  if(rvAuth.role === 'supervisor'){
    userKey = rvAuth.supervisor;
  }

  if(!userKey || !rvPasswords[userKey]){
    alert('Usu√°rio inv√°lido.');
    return;
  }

  const atual = prompt('Digite sua senha atual:');
  if(atual !== rvPasswords[userKey]){
    alert('Senha atual incorreta.');
    return;
  }

  const nova = prompt('Digite a nova senha (4 d√≠gitos):');
  if(!/^\d{4}$/.test(nova)){
    alert('A nova senha deve ter 4 d√≠gitos.');
    return;
  }

  // üö´ evitar duplica√ß√£o
  if(Object.entries(rvPasswords).some(([k,v]) => v === nova && k !== userKey)){
    alert('Essa senha j√° est√° em uso.');
    return;
  }

  rvPasswords[userKey] = nova;
  localStorage.setItem('rvPasswords', JSON.stringify(rvPasswords));

  alert('Senha alterada com sucesso.');
}




  // ===== Render principal (v6.3 intacta) =====
  function renderAll(){ const filtered = applyCurrentFilters(rowsResumo); renderTable(filtered); updateKPIs(filtered); updateCharts(filtered); renderActiveBadges(); updateFooterTotals(filtered); window.__lastFilteredRows = filtered; updateSupervisores(); }
  function initFilters(){ if(filtrosInicializados) return; const gSet = new Set(rowsResumo.map(r=>String(r.GESTOR||''))); const sSet = new Set(rowsResumo.map(r=>String(r.SETOR||''))); const gestores = Array.from(gSet).filter(x=>x).sort(); const setores = Array.from(sSet).filter(x=>x).sort(); document.getElementById('fltGestor').innerHTML = gestores.map(g=>`<option value="${g}">${g}</option>`).join(''); document.getElementById('fltSetor').innerHTML = setores.map(s=>`<option value="${s}">${s}</option>`).join(''); filtrosInicializados=true; }
  function selectedValues(sel){ return Array.from(sel.selectedOptions).map(o=>o.value); }
  function applyCurrentFilters(rows){ const q = state.q.toLowerCase(); const gSel = state.gSel; const sSel = state.sSel; return rows.filter(r=>{ const gOk = !gSel.length || gSel.includes(String(r.GESTOR)); const sOk = !sSel.length || sSel.includes(String(r.SETOR)); const qOk = !q || String(r.COLABORADOR).toLowerCase().includes(q) || String(r['ID VENDEDOR']).includes(q); return gOk && sOk && qOk; }); }
function renderTable(rows){
  const tbody = document.querySelector('#tblResumo tbody');
  tbody.innerHTML = rows.map(r=>`
      <tr>
        <td>${r['ID VENDEDOR']}</td>
        <td>${r['COLABORADOR']}</td>
        <td><span class="badge bg-secondary">${r['SETOR']}</span></td>
        <td><span class="badge bg-info text-dark">${r['GESTOR']}</span></td>
        <td>${r['QTD_VENDAS']}</td>
        <td>${fmtBRL(r['VAL_15_VENDAS_ELEGIVEL'])} ${r['ELEGIVEL_VENDAS']?'':'<span class="badge bg-warning text-dark">n√£o eleg√≠vel</span>'}</td>
        <td>${r['QTD_RENT']}</td>
        <td>${fmtBRL(r['VAL_RENT'])}</td>
        <td>${r['QTD_EST_APTOS']}</td>
        <td>${fmtBRL(r['VAL_15_ESTORNOS'])}</td>
        <td>${r['QTD_SKY']||0}</td>
        <td>${fmtBRL(r['VAL_SKY']||0)}</td>
        <td>${r['QTD_RET']||0}</td> <!-- üîπ QTD Reten√ß√£o -->
        <td>${fmtBRL(r['VAL_RET']||0)}</td> <!-- üîπ Reten√ß√£o (R$) -->
        <td><strong>${fmtBRL(r['TOTAL_RECEBER'])}</strong></td>
      </tr>
    `).join('');
}

  function updateFooterTotals(rows){ const sumN = (k)=> rows.reduce((a,r)=> a + (parseNumber(r[k])||0), 0); const sumI = (k)=> rows.reduce((a,r)=> a + (r[k]||0), 0); document.getElementById('ftQVend').textContent = sumN('QTD_VENDAS'); document.getElementById('ftV15').textContent = fmtBRL(sumI('VAL_15_VENDAS_ELEGIVEL')); document.getElementById('ftQRent').textContent = sumN('QTD_RENT'); document.getElementById('ftRent').textContent = fmtBRL(sumI('VAL_RENT')); document.getElementById('ftQEst').textContent = sumN('QTD_EST_APTOS'); document.getElementById('ftEst').textContent = fmtBRL(sumI('VAL_15_ESTORNOS')); document.getElementById('ftTotal').textContent = fmtBRL(sumI('TOTAL_RECEBER')); }
  function renderActiveBadges(){ const area = document.getElementById('activeFilters'); const badges = []; if(state.gSel.length) badges.push(`<span class=\"badge bg-primary\">Gestor: ${state.gSel.join(', ')}</span>`); if(state.sSel.length) badges.push(`<span class=\"badge bg-primary\">Setor: ${state.sSel.join(', ')}</span>`); if(state.q) badges.push(`<span class=\"badge bg-secondary\">Busca: ${state.q}</span>`); area.innerHTML = badges.join(' '); }
  function updateKPIs(rows){ const sum = (key) => rows.reduce((a,r)=>a+(r[key]||0),0); document.getElementById('kpiVendasValor').textContent = fmtBRL(sum('VAL_15_VENDAS_ELEGIVEL')); document.getElementById('kpiRentValor').textContent   = fmtBRL(sum('VAL_RENT')); document.getElementById('kpiEstValor').textContent    = fmtBRL(sum('VAL_15_ESTORNOS')); document.getElementById('kpiTotal').textContent       = fmtBRL(sum('TOTAL_RECEBER')); }

  // ===== Gr√°ficos (v6.3 + SKY+ e RETEN√á√ÉO) =====
const ctxGestor = document.getElementById('chartGestor');
const ctxTop = document.getElementById('chartTop');
let chartGestor, chartTop;
function updateCharts(rows){
  const mapG = new Map();

  rows.forEach(r=>{
    const g = String(r.GESTOR || '');

    const prev = mapG.get(g) || {
      vendas: 0,
      rent: 0,
      est: 0,
      sky: 0,
      ret: 0,
      total: 0
    };

    mapG.set(g, {
      vendas: prev.vendas + (r.VAL_15_VENDAS_ELEGIVEL || 0),
      rent:   prev.rent   + (r.VAL_RENT || 0),
      est:    prev.est    + (r.VAL_15_ESTORNOS || 0),

      // üî• AQUI EST√Å O PONTO-CHAVE
      sky:    prev.sky    + (r.VAL_SKY || 0),
      ret:    prev.ret    + (r.VAL_RET || 0),

      total:  prev.total  + (r.TOTAL_RECEBER || 0)
    });
  });

  const labelsG = Array.from(mapG.keys());

  const dataVend = labelsG.map(l=>mapG.get(l).vendas);
  const dataRent = labelsG.map(l=>mapG.get(l).rent);
  const dataEst  = labelsG.map(l=>-mapG.get(l).est);
  const dataSky  = labelsG.map(l=>mapG.get(l).sky);
  const dataRet  = labelsG.map(l=>mapG.get(l).ret);

  if(!chartGestor){
    chartGestor = new Chart(ctxGestor,{
      type:'bar',
      data:{
        labels:labelsG,
        datasets:[
          { label:'FTTH', data:dataVend, backgroundColor:'#3b82f6' },
          { label:'Rentabilidade', data:dataRent, backgroundColor:'#22c55e' },
          { label:'Estornos', data:dataEst, backgroundColor:'#ef4444' },
          { label:'SKY+', data:dataSky, backgroundColor:'#a855f7' },
          { label:'Reten√ß√£o', data:dataRet, backgroundColor:'#f59e0b' }
        ]
      },
      options:{
        responsive:true,
        plugins:{ legend:{ position:'bottom' } },
        scales:{ y:{ beginAtZero:true } }
      }
    });
  } else {
    chartGestor.data.labels = labelsG;
    chartGestor.data.datasets[0].data = dataVend;
    chartGestor.data.datasets[1].data = dataRent;
    chartGestor.data.datasets[2].data = dataEst;
    chartGestor.data.datasets[3].data = dataSky;
    chartGestor.data.datasets[4].data = dataRet;
    chartGestor.update();
  }


  // ===== TOP 10 COLABORADORES (INALTERADO) =====
  const sorted = [...rows]
    .sort((a,b)=> (b.TOTAL_RECEBER||0) - (a.TOTAL_RECEBER||0))
    .slice(0,10);

  const labelsT = sorted.map(r=>r.COLABORADOR);
  const totalsT = sorted.map(r=>r.TOTAL_RECEBER);

  if(!chartTop){
    chartTop = new Chart(ctxTop,{
      type:'bar',
      data:{
        labels:labelsT,
        datasets:[
          { label:'√Ä Receber (R$)', data:totalsT, backgroundColor:'#a78bfa' }
        ]
      },
      options:{
        indexAxis:'y',
        plugins:{ legend:{ display:false } },
        scales:{ x:{ beginAtZero:true } }
      }
    });
  } else {
    chartTop.data.labels = labelsT;
    chartTop.data.datasets[0].data = totalsT;
    chartTop.update();
  }
}

  // ===== Helpers comuns para RV (supervisores & gerentes) =====
  function supMaps(){
    const cFId = colByName(filasRowsRaw, ['id vendedor','id_vendedor','id do vendedor']);
    const cSup = colByName(filasRowsRaw, ['GESTOR','gestor','supervisor']);
    const idToSup = new Map();
    filasRowsRaw.forEach(r=>{ const id=parseNumber(r[cFId]); if(!id) return; idToSup.set(id, String(r[cSup]||'')); });
    const cMetaSup = colByName(metasRowsRaw, ['GESTOR','gestor','supervisor']);
    const cMetaVal = colByName(metasRowsRaw, ['META BL','meta bl','meta']);
    const metas=new Map(); if(cMetaSup && cMetaVal){ metasRowsRaw.forEach(r=>{ const sup=String(r[cMetaSup]||'').trim(); const m=parseNumber(r[cMetaVal]); if(sup) metas.set(sup,m); }); }
    const cIdV = colByName(vendRowsRaw, ['id vendedor','id_vendedor','id do vendedor']);
    const cContrato = colByName(vendRowsRaw, ['contrato']);
    const realizado=new Map(); vendRowsRaw.forEach(r=>{ const id=parseNumber(r[cIdV]); if(!id) return; const sup=idToSup.get(id)||''; if(!sup) return; const contrato=String(r[cContrato]||''); if(norm(contrato).includes('movel')) return; realizado.set(sup,(realizado.get(sup)||0)+1); });
    return {metas, realizado};
  }

  // ===== RV Supervisores (v6.3 intacta) =====
  function calcComissaoSup(pct){ const base=1800; if(pct<50) return 0; if(pct<70) return 0.8*base; if(pct<100) return 0.9*base; if(pct===100) return base; return (pct/100)*base; }
  function updateSupervisores(){
    const {metas, realizado} = supMaps();
    // autoriza√ß√£o: master v√™ todos; supervisor v√™ apenas o pr√≥prio
    let supFilter = null;
    if(rvAuth.role==='supervisor' && rvAuth.supervisor){ supFilter = new Set([norm(rvAuth.supervisor)]); }
    else if(rvAuth.role==='master'){ supFilter = null; }
    else{ document.querySelector('#rvCard').classList.add('hidden'); return; }
    const supSet = new Set([ ...metas.keys(), ...realizado.keys() ]);
    const linhas = Array.from(supSet).filter(s=> s && (!supFilter || supFilter.has(norm(s))) ).map(s=>{
      const meta = metas.get(s) || 0;
      const real = realizado.get(s) || 0;
      const pct  = meta>0 ? (real/meta)*100 : 0;
      const valor= calcComissaoSup(pct);
      return { SUPERVISOR:s, META_BL:meta, REALIZADO:real, PCT_ATINGIDO:pct, VALOR:valor };
    }).sort((a,b)=> a.SUPERVISOR.localeCompare(b.SUPERVISOR));
    const tbody = document.querySelector('#tblSupervisores tbody');
    tbody.innerHTML = linhas.map(r=>`<tr><td>${r.SUPERVISOR}</td><td>${r.META_BL}</td><td>${r.REALIZADO}</td><td>${fmtPct(r.PCT_ATINGIDO)}</td><td><strong>${fmtBRL(r.VALOR)}</strong></td></tr>`).join('');
   if(rvAuth.role==='master'){
  const ul=document.getElementById('rvPasswordsUl');
  ul.innerHTML = Object.entries(rvPasswords)
    .sort(([a],[b])=> a.localeCompare(b))
    .map(([sup,pass])=> `<li><strong>${sup}</strong>: ${pass}</li>`)
    .join('');
}

  }

  // ===== NOVO: RV GERENTES (INCLUS√ÉO m√≠nima, independente) =====
  const GER_ALLOWED = new Set(['1705','5150']);
  const gruposGerente = {
    'giovani mazzini': ['adriana','amanda','bianca','denis','kaoani','simone','welington'],
    'alan paranhos': ['la√≠s','lais','kelly','tainara']
  };
  function calcComGerente(pct){ const base=5500; if(pct<50) return 0; if(pct<70) return 0.8*base; if(pct<100) return 0.9*base; if(pct===100) return base; return (pct/100)*base; }
  function calcComAndriele(pct){ const base=4400; if(pct<50) return 0; if(pct<70) return 0.8*base; if(pct<100) return 0.9*base; if(pct===100) return base; return (pct/100)*base; }
  function handleRvGerAccess(){
  const pass = prompt('Digite sua senha para acessar RV GERENTES:');
  if(pass == null) return;

  // üîí 9911 ‚Üí SOMENTE ANDRIELE VELOSO
  // N√ÉO acessa RV Supervisores
  if(pass === '9911'){
    rvGerenteFiltro = 'andriele veloso';
    document.getElementById('rvGerCard').classList.remove('hidden');
    document.getElementById('rvGerInfo').textContent =
      'Acesso restrito: ANDRIELE VELOSO';
    updateGerentes();
    return;
  }

  // üîí 2908 ‚Üí SOMENTE ALAN PARANHOS
  if(pass === '2908'){
    rvGerenteFiltro = 'alan paranhos';
    document.getElementById('rvGerCard').classList.remove('hidden');
    document.getElementById('rvGerInfo').textContent =
      'Acesso restrito: ALAN PARANHOS';
    updateGerentes();
    return;
  }

  // Gerentes normais (igual antes)
  if(!GER_ALLOWED.has(pass)){
    alert('Acesso negado.');
    return;
  }

  rvGerenteFiltro = null;
  document.getElementById('rvGerCard').classList.remove('hidden');
  document.getElementById('rvGerInfo').textContent =
    'Acesso RV GERENTES liberado';
  updateGerentes();
}

  function hideRvGer(){ document.getElementById('rvGerCard').classList.add('hidden'); }
  function updateGerentes(){
  const { metas, realizado } = supMaps();
  let rows = [];

  // GIOVANI MAZZINI
  (function(){
    const g = 'giovani mazzini';
    const sups = gruposGerente[g] || [];
    let meta = 0, real = 0;

    sups.forEach(s=>{
      const kn = norm(s);
      const mk = Array.from(metas.keys()).find(m=> norm(m)===kn);
      meta += (mk ? metas.get(mk) : 0);
      const rk = Array.from(realizado.keys()).find(m=> norm(m)===kn);
      real += (rk ? realizado.get(rk) : 0);
    });

    const pct = meta>0 ? (real/meta)*100 : 0;
    const valor = calcComGerente(pct);
    rows.push({ GERENTE:'GIOVANI MAZZINI', META_BL:meta, REALIZADO:real, PCT_ATINGIDO:pct, VALOR:valor });
  })();

  // ALAN PARANHOS
  (function(){
    const g = 'alan paranhos';
    const sups = gruposGerente[g] || [];
    let meta = 0, real = 0;

    sups.forEach(s=>{
      const kn = norm(s);
      const mk = Array.from(metas.keys()).find(m=> norm(m)===kn);
      meta += (mk ? metas.get(mk) : 0);
      const rk = Array.from(realizado.keys()).find(m=> norm(m)===kn);
      real += (rk ? realizado.get(rk) : 0);
    });

    const pct = meta>0 ? (real/meta)*100 : 0;
    const valor = calcComGerente(pct);
    rows.push({ GERENTE:'ALAN PARANHOS', META_BL:meta, REALIZADO:real, PCT_ATINGIDO:pct, VALOR:valor });
  })();

  // ANDRIELE VELOSO
  (function(){
    let meta = 20000;
    let real = 0;
    const cCom = colByName(rentRowsRaw, ['comissao','comiss√£o','i']);
    if(cCom){
      rentRowsRaw.forEach(r=>{
        real += parseNumber(r[cCom]);
      });
    }
    const pct = meta>0 ? (real/meta)*100 : 0;
    const valor = calcComAndriele(pct);
    rows.push({ GERENTE:'ANDRIELE VELOSO', META_BL:meta, REALIZADO:real, PCT_ATINGIDO:pct, VALOR:valor });
  })();

  // üîí FILTRO POR ACESSO ESPECIAL (2908 / 9911)
  if (typeof rvGerenteFiltro !== 'undefined' && rvGerenteFiltro) {
    rows = rows.filter(r =>
      norm(r.GERENTE) === norm(rvGerenteFiltro)
    );
  }

function updateGerentes(){
  const { metas, realizado } = supMaps();
  let rows = [];

  // ... TODOS OS BLOCOS DOS GERENTES
  // GIOVANI
  // ALAN
  // ANDRIELE

  // üîí FILTRO FINAL ‚Äî N√ÉO MEXA EM MAIS NADA
  if(rvGerenteFiltro){
    rows = rows.filter(r =>
      norm(r.GERENTE) === norm(rvGerenteFiltro)
    );
  }

  const tbody = document.querySelector('#tblGerentes tbody');
  tbody.innerHTML = rows.map(r => `
    <tr>
      <td>${r.GERENTE}</td>
      <td>${r.META_BL}</td>
      <td>${r.REALIZADO}</td>
      <td>${fmtPct(r.PCT_ATINGIDO)}</td>
      <td><strong>${fmtBRL(r.VALOR)}</strong></td>
    </tr>
  `).join('');
}

  const tbody = document.querySelector('#tblGerentes tbody');
  tbody.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.GERENTE}</td>
      <td>${r.META_BL}</td>
      <td>${r.REALIZADO}</td>
      <td>${fmtPct(r.PCT_ATINGIDO)}</td>
      <td><strong>${fmtBRL(r.VALOR)}</strong></td>
    </tr>
  `).join('');
}


 async function handleFile(file){
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data, {type:'array'});

  const sFILAS = findSheet(wb, ['filas']);
  const sVEND  = findSheet(wb, ['vendas instaladas','instaladas']);
  const sRENT  = findSheet(wb, ['rentabilizacao','rentabiliza√ß√£o']);
  const sEST   = findSheet(wb, ['estornos','estorno']);
  const sMETAS = findSheet(wb, ['metas','meta']);
  const sSKY   = findSheet(wb, ['sky','sky+']);   // üîπ nova planilha SKY

  if(!sFILAS || !sVEND || !sRENT || !sEST){
    alert('N√£o encontrei todas as planilhas necess√°rias (FILAS, Vendas Instaladas, Rentabiliza√ß√£o, Estornos).');
    return;
  }

  filasRowsRaw = sheetToRows(wb.Sheets[sFILAS]);
  vendRowsRaw  = sheetToRows(wb.Sheets[sVEND]);
  rentRowsRaw  = sheetToRows(wb.Sheets[sRENT]); // j√° usado para RV Gerentes
  metasRowsRaw = sMETAS ? sheetToRows(wb.Sheets[sMETAS]) : [];
  const rentRows = rentRowsRaw;
  const estRows  = sheetToRows(wb.Sheets[sEST]);
  const skyRowsRaw = sSKY ? sheetToRows(wb.Sheets[sSKY]) : []; // üîπ leitura SKY

  // üîπ Processar SKY e atualizar rowsResumo
  const skyMap = processSkySheet(wb);
// üîπ Processar Reten√ß√£o
const retMap = processRetencaoSheet(wb);

  // Colunas base (v6.3)
  const cIdV = colByName(vendRowsRaw, ['id vendedor','id_vendedor','id do vendedor']);
  const cValValidos = colByName(vendRowsRaw, ['validos','v√°lidos']);
  const cIdR = colByName(rentRows, ['id vendedor','id_vendedor','id do vendedor']);
  const cComissao = colByName(rentRows, ['comissao','comiss√£o']);
  const cIdE = colByName(estRows, ['id vendedor','id_vendedor','id do vendedor']);
  const cPontos = colByName(estRows, ['pontos']);
  const cValPlano = colByName(estRows, ['valor plano','valor_plano']);
  const cFId = colByName(filasRowsRaw, ['id vendedor','id_vendedor','id do vendedor']);
  const cColab = colByName(filasRowsRaw, ['colaborador']);
  const cSetor = colByName(filasRowsRaw, ['setor']);
  const cGestor = colByName(filasRowsRaw, ['gestor']);

  if(!cIdV || !cValValidos || !cIdR || !cComissao || !cIdE || !cPontos || !cValPlano || !cFId || !cColab || !cSetor || !cGestor){
    alert('Verifique os nomes das colunas: ID VENDEDOR, V√°lidos (K), Comiss√£o (I), Pontos (H), Valor Plano (G) e os campos de FILAS (ID, Colaborador, Setor, Gestor).');
    return;
  }

  // Aggregations (v6.3)
  const aggVendasQty = new Map();
  const aggVendasVal = new Map();
  vendRowsRaw.forEach(r=>{
    const id=parseNumber(r[cIdV]);
    if(!id) return;
    const val=parseNumber(r[cValValidos]);
    aggVendasQty.set(id,(aggVendasQty.get(id)||0)+1);
    aggVendasVal.set(id,(aggVendasVal.get(id)||0)+val*0.15);
  });

  const aggRentQty = new Map();
  const aggRentVal = new Map();
  rentRows.forEach(r=>{
    const id=parseNumber(r[cIdR]);
    if(!id) return;
    const val=parseNumber(r[cComissao]);
    aggRentQty.set(id,(aggRentQty.get(id)||0)+1);
    aggRentVal.set(id,(aggRentVal.get(id)||0)+val);
  });

  const aggEstQty = new Map();
  const aggEstVal = new Map();
  estRows.forEach(r=>{
    const id=parseNumber(r[cIdE]);
    if(!id) return;
    const pontos=parseNumber(r[cPontos]);
    const vp=parseNumber(r[cValPlano]);
    if(pontos>=30 && pontos<=90){
      aggEstQty.set(id,(aggEstQty.get(id)||0)+1);
      aggEstVal.set(id,(aggEstVal.get(id)||0)+vp*0.15);
    }
  });

  // Map FILAS
  const mapInfo = new Map();
  filasRowsRaw.forEach(r=>{
    const id=parseNumber(r[cFId]);
    if(!id) return;
    mapInfo.set(id,{
      'ID VENDEDOR':id,
      'COLABORADOR':r[cColab]||'',
      'SETOR':r[cSetor]||'',
      'GESTOR':r[cGestor]||''
    });
  });

  // Build rowsResumo (v6.3) + SKY
const allIds = new Set([
  ...mapInfo.keys(),
  ...aggVendasQty.keys(),
  ...aggRentQty.keys(),
  ...aggEstQty.keys(),
  ...skyMap.keys(),
  ...retMap.keys()   // üîπ FALTAVA ISSO
]);

  rowsResumo = Array.from(allIds).map(id=>{
    const base = mapInfo.get(id)||{'ID VENDEDOR':id,'COLABORADOR':'(sem nome)','SETOR':'','GESTOR':''};
    const qVend = aggVendasQty.get(id)||0;
    const vVend15 = aggVendasVal.get(id)||0;
    const qRent = aggRentQty.get(id)||0;
    const vRent = aggRentVal.get(id)||0;
    const qEst = aggEstQty.get(id)||0;
    const vEst15 = aggEstVal.get(id)||0;

    const sky = skyMap.get(id) || {qtd:0, valor:0};

    const setorNorm = norm(base['SETOR']);
    const precisaMeta = setoresComGatilho.has(setorNorm);
    const elegivelVendas = !precisaMeta || (qVend >= 30);
    const vVend15Elegivel = elegivelVendas ? vVend15 : 0;

   const ret = retMap.get(id) || { qtdTotal: 0, qtdRetido: 0 };

const pctRet = ret.qtdTotal
  ? (ret.qtdRetido / ret.qtdTotal) * 100
  : 0;

const elegivelRet = ret.qtdTotal >= 30 && pctRet >= 20;

const valRet = elegivelRet
  ? ret.qtdRetido * 15 // R$ 15 por retido
  : 0;

const totalReceber =
  vVend15Elegivel +
  vRent -
  vEst15 +
  sky.valor +
  valRet;

return {
  ...base,

  'QTD_VENDAS': qVend,
  'VAL_15_VENDAS_ELEGIVEL': vVend15Elegivel,
  'ELEGIVEL_VENDAS': elegivelVendas,

  'QTD_RENT': qRent,
  'VAL_RENT': vRent,

  'QTD_EST_APTOS': qEst,
  'VAL_15_ESTORNOS': vEst15,

  'QTD_SKY': sky.qtd,
  'VAL_SKY': sky.valor,

  'QTD_RET': ret.qtdTotal
    ? `${ret.qtdTotal} | ${pctRet.toFixed(1)}%`
    : '0 | 0.0%',

  'VAL_RET': valRet,

  'TOTAL_RECEBER': totalReceber
};



  });

  initFilters(); 
  state.gSel=[]; 
  state.sSel=[]; 
  state.q='';
  renderAll();
}


  // ===== Eventos UI (v6.3 intactos + novos bot√µes RV Gerentes) =====
  const fltGestor=document.getElementById('fltGestor'); const fltSetor=document.getElementById('fltSetor');
  document.getElementById('fileInput').addEventListener('change',(ev)=>{ const f=ev.target.files?.[0]; if(f) handleFile(f); });
  document.getElementById('btnClearGestor').onclick=()=>{ Array.from(fltGestor.options).forEach(o=>o.selected=false); state.gSel=[]; renderAll(); };
  document.getElementById('btnClearSetor').onclick=()=>{ Array.from(fltSetor.options).forEach(o=>o.selected=false); state.sSel=[]; renderAll(); };
  document.getElementById('btnSelectAllGestor').onclick=()=>{ Array.from(fltGestor.options).forEach(o=>o.selected=true); state.gSel=selectedValues(fltGestor); renderAll(); };
  document.getElementById('btnSelectAllSetor').onclick=()=>{ Array.from(fltSetor.options).forEach(o=>o.selected=true); state.sSel=selectedValues(fltSetor); renderAll(); };
  fltGestor.onchange=()=>{ state.gSel=selectedValues(fltGestor); renderAll(); };
  fltSetor.onchange=()=>{ state.sSel=selectedValues(fltSetor); renderAll(); };
  document.getElementById('txtBusca').oninput=(e)=>{ state.q=e.target.value||''; renderAll(); };
  document.getElementById('btnExportar').onclick=()=>{ const rows=window.__lastFilteredRows||[]; const data=rows.map(r=>({ 'ID VENDEDOR':r['ID VENDEDOR'], 'COLABORADOR':r['COLABORADOR'], 'SETOR':r['SETOR'], 'GESTOR':r['GESTOR'], 'QTD Vendas':r['QTD_VENDAS'], 'Vendas (R$)':r['VAL_15_VENDAS_ELEGIVEL'], 'QTD Rent':r['QTD_RENT'], 'Rentab. (R$)':r['VAL_RENT'], 'Estornos (R$)':r['QTD_EST_APTOS'], 'Estornos (R$)':r['VAL_15_ESTORNOS'], '√Ä Receber (R$)':r['TOTAL_RECEBER'] })); const sumN=(k)=> rows.reduce((a,r)=> a+(parseNumber(r[k])||0),0); const sumI=(k)=> rows.reduce((a,r)=> a+(r[k]||0),0); data.push({ 'ID VENDEDOR':'', 'COLABORADOR':'', 'SETOR':'', 'GESTOR':'Totais', 'QTD Vendas':sumN('QTD_VENDAS'), 'Vendas (R$)':sumI('VAL_15_VENDAS_ELEGIVEL'), 'QTD Rent':sumN('QTD_RENT'), 'Rentab. (R$)':sumI('VAL_RENT'), 'Estornos (R$)':sumN('QTD_EST_APTOS'), 'Estornos (R$)':sumI('VAL_15_ESTORNOS'), '√Ä Receber (R$)':sumI('TOTAL_RECEBER') }); const ws=XLSX.utils.json_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Tabela Filtrada'); const nome='tabela_filtrada_'+new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')+'.xlsx'; XLSX.writeFile(wb, nome); };
  document.getElementById('btnRvAccess').onclick = handleRvAccess; // Supervis√£o
document.getElementById('btnRvHide').onclick = hideRv; // Supervis√£o
document.getElementById('btnShowPasswords').onclick = ()=>{ 
  const list=document.getElementById('rvPasswordsList'); 
  if(list.classList.contains('hidden')) list.classList.remove('hidden'); 
  else list.classList.add('hidden'); 
};
document.getElementById('btnRvGerAccess').onclick = handleRvGerAccess; // Gerentes
document.getElementById('btnRvGerHide').onclick = hideRvGer; // Gerentes

// ‚úÖ NOVO ‚Äî troca de senha (Supervisor)
document.getElementById('btnChangeMyPass').onclick = handleChangeMyPassword;

</script>
</body>
</html>
